name: API Comparison CI/CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Позволяет запускать pipeline вручную

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Build and run services
        run: |
          docker-compose build
          docker-compose up -d db
          # Ждем пока БД поднимется и будет готова к работе
          sleep 10
          docker-compose up -d rest-api graphql-api grpc-api
      
      - name: Run tests
        run: |
          # Запускаем контейнер с тестами
          docker-compose run --rm tests bash -c "cd /tests && chmod +x run-tests.sh && ./run-tests.sh"
      
      - name: Debug test results
        run: |
          echo "Listing generated files in results/ directory:"
          ls -al results/ || echo "No results directory found!"

      - name: Upload test results
        if: success() && steps.run-tests.outputs.exit-code == 0  # Ensure the previous step succeeded
        uses: actions/upload-artifact@v3
        with:
          name: test-results
          path: results/